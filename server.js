// server.js (ุงููุณุฎุฉ ุงูููุงุฆูุฉ: ุงูุญุงุฑุณ ุงูุฐูู + ุงูุชุงูู ุฃูุช + ุจุฏูู ุญุฐู)
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { Pool } = require('pg'); // ุงูููุชุจุฉ ุงูุฌุฏูุฏุฉ
const OpenAI = require('openai');
const { GoogleGenerativeAI } = require("@google/generative-ai");
const path = require('path');

const app = express();
app.use(express.json());
app.use(cors());
app.use(express.static(path.join(__dirname, '.')));

// 1. ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ
// ุณูุฃุฎุฐ ุงูุฑุงุจุท ูู ุฅุนุฏุงุฏุงุช Render ูุจุงุดุฑุฉ
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: {
    rejectUnauthorized: false // ุถุฑูุฑู ุนุดุงู ุงูุงุชุตุงู ุงููุดูุฑ
  }
});

// ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุฌุฏูู (ูู ูุด ููุฌูุฏ ููุดุฆู)
pool.query(`
  CREATE TABLE IF NOT EXISTS studies (
    id SERIAL PRIMARY KEY,
    activity_name TEXT UNIQUE,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  )
`).then(() => console.log('โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ ุจูุฌุงุญ.'))
  .catch(err => console.error('โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช:', err));

// 2. ุฅุนุฏุงุฏ ุงูููุงุชูุญ
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);
const googleModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

// 3. ุฏุงูุฉ ุชูุญูุฏ ุงูุงุณู (ุงููุนุฏูุฉ: ุงูุญุงุฑุณ ุงูุฐูู)
async function getStandardName(userInput) {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-3.5-turbo", 
      messages: [
        { 
            role: "system", 
            content: `ุฃูุช ุฎุจูุฑ ุชุตููู ุฃูุดุทุฉ ุงูุชุตุงุฏูุฉ. ุงุชุจุน ุงูููุงุนุฏ ุงูุชุงููุฉ ุญุฑูููุง:

---------------------------------------------------------
๐น ุฃููุงู โ ุงูุฃูุดุทุฉ ุงูุฒุฑุงุนูุฉ ูุงูุฅูุชุงุฌ ุงูุญููุงูู
---------------------------------------------------------
ุฅุฐุง ุงุญุชูู ุงููุต ุนูู ูููุงุช ูุซู:
"ูุฒุฑุนุฉ" ุ "ุชุฑุจูุฉ" ุ "ููุงุดู" ุ "ุชุณููู" ุ "ุนุฌูู" ุ "ุฏูุงุฌู" ุ
"ุฃุบูุงู" ุ "ูุงุนุฒ" ุ "ุฅูุชุงุฌ ุญููุงูู" ุ "ุฃูุจุงู" ุ "ุฃุฑุงูุจ" ุ "ุฒุฑุงุนุฉ" ุ "ูุญุตูู"

โ ูุตูู ุฅูู: **ุฅูุชุงุฌ ุฒุฑุงุนู / ุฅูุชุงุฌ ุญููุงูู**

โ ููููุน ุชุญููู ุฃู ูุดุงุท ูุจุฏุฃ ุจู (ูุฒุฑุนุฉ/ุชุฑุจูุฉ/ุชุณููู/ุฅูุชุงุฌ) ุฅูู ุตูุงุนุฉ.

ุฃูุซูุฉ:
- ูุฒุฑุนุฉ ููุงุดู โ ุชุฑุจูุฉ ูุฅูุชุงุฌ ุงูููุงุดู  
- ุชุณููู ุนุฌูู โ ูุดุงุท ุชุณููู ุงูุนุฌูู  

---------------------------------------------------------
๐น ุซุงูููุง โ ุงูุฃูุดุทุฉ ุงูุชุฌุงุฑูุฉ
---------------------------------------------------------
ุฅุฐุง ุงุญุชูู ุงููุต ุนูู ูููุงุช ูุซู:
"ุชุฌุงุฑุฉ" ุ "ุจูุน" ุ "ูุญู" ุ "ูุชุฌุฑ" ุ "ุฌููุฉ" ุ "ุชุฌุฒุฆุฉ" ุ "ุจุงุฒุงุฑ" ุ "ุดุฑุงุก"

โ ูุตูู ุฅูู: **ูุดุงุท ุชุฌุงุฑู**

โ ููููุน ุชุญููู ุฃู ูุดุงุท ูุจุฏุฃ ุจู ุชุฌุงุฑุฉ/ูุญู โ ุตูุงุนุฉ.

ุฃูุซูุฉ:
- ุชุฌุงุฑุฉ ุงูููุงุจุณ โ ุชุฌุงุฑุฉ ุงูููุงุจุณ ุงูุฌุงูุฒุฉ ุจุงูุชุฌุฒุฆุฉ  
- ูุญู ุฃุฏูุงุช ููุฑุจุงุฆูุฉ โ ุชุฌุงุฑุฉ ุงูุฃุฏูุงุช ุงูููุฑุจุงุฆูุฉ  

---------------------------------------------------------
๐น ุซุงูุซูุง โ ุงูุฃูุดุทุฉ ุงูุตูุงุนูุฉ
---------------------------------------------------------
ุฅุฐุง ุงุญุชูู ุงููุต ุนูู ูููุงุช ูุซู:
"ูุตูุน" ุ "ุชุตููุน" ุ "ูุฑุดุฉ ุชุตููุน" ุ "ุฎุท ุฅูุชุงุฌ" ุ "ุตูุงุนุฉ"

โ ูุตูู ุฅูู: **ูุดุงุท ุตูุงุนู**

ูุซุงู:
- ูุตูุน ููุงุจุณ โ ุตูุงุนุฉ ุงูููุงุจุณ ุงูุฌุงูุฒุฉ  

---------------------------------------------------------
๐น ุฑุงุจุนูุง โ ุงูุฃูุดุทุฉ ุงูุฎุฏููุฉ (Service Activities)
---------------------------------------------------------
ุฅุฐุง ุงุญุชูู ุงููุต ุนูู ูููุงุช ูุซู:

"ุฎุฏูุฉ" ุ "ุฎุฏูุงุช" ุ "ุตูุงูุฉ" ุ "ุฅุตูุงุญ" ุ  
"ุชูุธูู" ุ "ูุบุณูุฉ" ุ  
"ุณุจุงูุฉ" ุ "ููุฑุจุงุก" ุ "ูููุงูููู" ุ  
"ุตุงููู" ุ "ููุงููุฑ" ุ "ูุฑูุฒ ุชุฌููู" ุ  
"ูุทุนู" ุ "ูุงููู" ุ "ูููู ุดูุจ" ุ  
"ุชุนููู" ุ "ุชุฏุฑูุจ" ุ "ุญุถุงูุฉ" ุ  
"ุชุตููุฑ" ุ "ูููุชุงุฌ" ุ "ุชุตููู" ุ "ุทุจุงุนุฉ"ุ  
"ุชูุตูู" ุ "ุฏูููุฑู" ุ "ููู" ุ "ุชุงูุณู" ุ "ุฃูุจุฑ" ุ  
"ุนูุงุฏุฉ" ุ "ุตูุฏููุฉ" ุ "ูุฎุชุจุฑ" ุ "ุชุญุงููู"

โ ูุตูู ุฅูู: **ูุดุงุท ุฎุฏูู (Service)**

ุฃูุซูุฉ:
- ุตุงููู ุญูุงูุฉ โ ุฎุฏูุงุช ุงูุชุฌููู ูุงูุญูุงูุฉ  
- ูุทุนู ูุฃูููุงุช โ ูุดุงุท ูุทุนู ูุฎุฏูุงุช ุบุฐุงุฆูุฉ  
- ุณุจุงูุฉ โ ุฎุฏูุงุช ุงูุณุจุงูุฉ  
- ูุฑุดุฉ ูููุงูููุง โ ุฎุฏูุงุช ุงูุฅุตูุงุญ ุงููููุงูููู  

---------------------------------------------------------
๐น ุฎุงูุณูุง โ ุงูุฃูุดุทุฉ ุบูุฑ ุงูุงูุชุตุงุฏูุฉ
---------------------------------------------------------
ุฅุฐุง ูุงู ุงููุต:
ููุงู ุนุงู โ ุณูุงุณุฉ โ ุฑูุงุถุฉ โ ููุช โ ุดุชุงุฆู โ ููุงู ูุงุฑุบ โ ุฃุบุงูู

โ ุงูุฑุฏ ููุท: **REFUSED**

---------------------------------------------------------
๐น ููุงุญุธุงุช ุตุงุฑูุฉ:
- ุงูุฑุฏ = **ุงูุงุณู ุงูุฑุณูู ูููุดุงุท ููุท**  
- ุจุฏูู ุดุฑุญ  
- ุจุฏูู ุชูุงุตูู  
- ุจุฏูู ุฃู ููุงู ุฅุถุงูู  

            ` 
        },
        { role: "user", content: userInput }
      ],
      temperature: 0.0,
    });
    return response.choices[0].message.content.trim();
  } catch (error) {
    console.error("OpenAI Error:", error);
    return userInput; 
  }
}

app.post('/generate-study', async (req, res) => {
  let userActivity = req.body.activity;
  console.log(`๐ ุฌุงุฑู ุงูุจุญุซ ุนู: ${userActivity}`);

  try {
    // 1๏ธโฃ ุชูุญูุฏ ุงูุงุณู (ูุน ุงูุญุงุฑุณ ุงูุฐูู)
    const standardName = await getStandardName(userActivity);
    
    // ๐ ูุญุต ุงูุฑูุถ: ูู ุงูุญุงุฑุณ ูุงู REFUSED ูููู ููุง
    if (standardName === "REFUSED") {
        console.log("โ ุชู ุฑูุถ ุงูุจุญุซ: ูุดุงุท ุบูุฑ ุตุงูุญ.");
        return res.status(400).json({ 
            error: "ุนููุงูุ ูุฐุง ูุง ูุจุฏู ูุงุณู ูุดุงุท ุชุฌุงุฑู ุฃู ุตูุงุนู ุตุญูุญ. ูุฑุฌู ุฅุฏุฎุงู ุงุณู ูุดุฑูุน ูุงุถุญ." 
        });
    }

    console.log(`โ ุงูุงุณู ุงูููุญุฏ: ${standardName}`);

    // 2๏ธโฃ ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ (Neon)
    const dbCheck = await pool.query("SELECT * FROM studies WHERE activity_name = $1", [standardName]);

    if (dbCheck.rows.length > 0) {
      console.log("๐ฐ ุงูุฏุฑุงุณุฉ ููุฌูุฏุฉ ูู ุงูุฃุฑุดูู ุงูุณุญุงุจู.");
      return res.json({ result: dbCheck.rows[0].content, source: "archive", official_name: standardName });
    }

    console.log("โก ุฌุงุฑู ุงูุฅูุดุงุก ุจุงุณุชุฎุฏุงู Google Gemini...");
    
    // 3๏ธโฃ ุงูุฅูุดุงุก ุจู Gemini (ุชู ุชุนุฏูู ุงูุจุฑููุจุช ููุญุชุฑู ุงูุชุฎุตุต)
    const prompt = `
      ุฃูุช ูุณุชุดุงุฑ ุงุฆุชูุงูู. ุงูุชุจ "ุฏุฑุงุณุฉ ุณูู ุชูุตูููุฉ" ููุดุงุท: "${standardName}".
      
      ุงููุชุทูุจุงุช:
      1. ุงููุฎุฑุฌ HTML ููุท (h3, ul, table).
      2. ุงูุชุจ ุจุงุณุชูุงุถุฉ ุดุฏูุฏุฉ ูุฃุฑูุงู ุชูุฏูุฑูุฉ.
      
      ุงููููู:
      <h3>1๏ธโฃ ูุธุฑุฉ ุนุงูุฉ</h3> (ููุฑุฉ ุทูููุฉ).
      <h3>2๏ธโฃ ุงูููุชุฌุงุช</h3> (ูุงุฆูุฉ).
      <h3>3๏ธโฃ ูููู ุงูุณูู</h3> (ุนุฏุฏ ุงููุตุงูุนุ ุงูููุงูุณุฉ).
      <h3>4๏ธโฃ ุฏูุฑุฉ ุงูุชุดุบูู (ุฃุฑูุงู)</h3> (ุฌุฏูู ุฃูุงู ุชุดุบูู).
      <h3>5๏ธโฃ ุงูุชูุงููู ูุงูููุงูุด</h3> (ูุณุจ ูุฆููุฉ).
      <h3>6๏ธโฃ SWOT</h3> (ุชุญููู ูุงูู).
      <h3>7๏ธโฃ ุงูุชูุตูุฉ</h3> (ุฑุฃู ุงุฆุชูุงูู).
      `;

    const result = await googleModel.generateContent(prompt);
    const studyContent = result.response.text();
    const cleanContent = studyContent.replace(/```html/g, '').replace(/```/g, '');

    // 4๏ธโฃ ุงูุญูุธ ูู Neon
    await pool.query(
      "INSERT INTO studies (activity_name, content) VALUES ($1, $2)",
      [standardName, cleanContent]
    );

    res.json({ result: cleanContent, source: "ai", official_name: standardName });

  } catch (error) {
    console.error("๐ฅ ุฎุทุฃ:", error);
    res.status(500).json({ error: "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ", details: error.message });
  }
});

// ุงุณุชุฑุฌุงุน ุงูุฃุฑุดูู ุจุงููุงูู
app.get('/all-studies', async (req, res) => {
    try {
        const result = await pool.query("SELECT * FROM studies ORDER BY id DESC");
        res.json({ studies: result.rows });
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "ูุดู ุชุญููู ุงูุฃุฑุดูู" });
    }
});

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

const PORT = process.env.PORT || 3000;
// ๐ ุงูุชุนุฏูู ุงูุฃุฎูุฑ: ุญูุธูุง ุงูุณูุฑูุฑ ูู ูุชุบูุฑ ุนุดุงู ูุฒูุฏ ุงูููุช
const server = app.listen(PORT, () => console.log(`๐ ุงูุณูุฑูุฑ ูุนูู ููุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช`));
server.setTimeout(300000); // 5 ุฏูุงุฆู ูููุฉ (ุนุดุงู ุงูุณูุฑูุฑ ูููุตูุด ูู ูุดู)