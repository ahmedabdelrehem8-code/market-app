// server.js (ูุณุฎุฉ ูุญุณููุฉ)
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');
const OpenAI = require('openai');
const { GoogleGenerativeAI } = require("@google/generative-ai");
const path = require('path');

const app = express();
app.use(express.json());
app.use(cors());
app.use(express.static(path.join(__dirname, '.')));

// 1. ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ (Neon / Render)
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: {
    rejectUnauthorized: false
  }
});

// ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุฌุฏูู
pool.query(`
  CREATE TABLE IF NOT EXISTS studies (
    id SERIAL PRIMARY KEY,
    activity_name TEXT UNIQUE,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  )
`).then(() => console.log('โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ ูุฅูุดุงุก ุงูุฌุฏูู (ุฅู ูู ููู ููุฌูุฏุงู).'))
  .catch(err => console.error('โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช:', err));

// 2. ุฅุนุฏุงุฏ ุงูููุงุชูุญ
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);
const googleModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

/**
 * 3. ุฏุงูุฉ ุชูุญูุฏ ุงูุงุณู (ุงูุฅุตุฏุงุฑ ุงูุฐูู)
 * - ูุง ูุญููู ูู ุดูุก ูุตูุงุนุฉ.
 * - ูุฑุงุนู ููุน ุงููุดุงุท (ุชุฌุงุฑุฉ / ุตูุงุนุฉ / ุฒุฑุงุนุฉ / ุฎุฏูุฉ) ุญุณุจ ูุง ูุชุจู ุงููุณุชุฎุฏู.
 * - ูู ุงููุต ูุด ูุดุงุท ุงูุชุตุงุฏู ูุงุถุญ โ ูุฑุฌูุน "REFUSED".
 */
async function getStandardName(userInput) {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: `
ุฃูุช ุฎุจูุฑ ุงุฆุชูุงู ูู ุจูู.
ูููุชู:
1) ุชูุฑุฃ ูุตู ุงููุดุงุท ููุง ูุชุจู ุงููุณุชุฎุฏู (ุชุฌุงุฑุฉ / ุตูุงุนุฉ / ุฒุฑุงุนุฉ / ุฎุฏูุฉ / ููู ุญุฑุฉ).
2) ูุง ุชุบูููุฑ ููุน ุงููุดุงุท:
   - ูู ูุชุจ "ุชุฌุงุฑุฉ ..." ูุจูู ุงููุดุงุท ุชุฌุงุฑู.
   - ูู ูุชุจ "ุตูุงุนุฉ ..." ุฃู "ูุตูุน" ูุจูู ุตูุงุนู.
   - ูู ูุชุจ "ูุฒุฑุนุฉ" ุฃู "ุฒุฑุงุนุฉ" ูุจูู ุฒุฑุงุนู.
   - ูู ูุชุจ "ุฎุฏูุงุช" ุฃู "ูุฑูุฒ" ุฃู "ุนูุงุฏุฉ" ูุจูู ุฎุฏูู.
3) ุชุนูุฏ ุตูุงุบุฉ ุงูุงุณู ููููู:
   - ูุตูุฑุ ุฑุณููุ ููุงุถุญ ุจุงูุนุฑุจูุฉ.
   - ูุซุงู:
     "ุชุฌุงุฑุฉ ุงูููุงุจุณ ุงูุฌุงูุฒุฉ ุจุงูุชุฌุฒุฆุฉ"
     "ุตูุงุนุฉ ุงูุฃุซุงุซ ุงูุฎุดุจู"
     "ูุฒุฑุนุฉ ูุชุฑุจูุฉ ุงูููุงุดู"
     "ูุฑูุฒ ุตูุงูุฉ ุฃุฌูุฒุฉ ููุฑุจุงุฆูุฉ"
4) ูู ุงููุต ูุง ูุจุฏู ููุดุงุท ุงูุชุตุงุฏู ุฃู ูุดุฑูุน (ูุซูุงู: ุดุชููุฉุ ุฌููุฉ ุจุฏูู ูุนููุ ุณุคุงู ุนุงู):
   - ุฃุฑุฌูุน ุจุงูุถุจุท ุงููููุฉ ุงูุชุงููุฉ ููุท: REFUSED

โฌ ุงููุทููุจ: ุงุฑุฌุน ุจุงูุงุณู ุงูููุญุฏ ููุท ุจุฏูู ุฃู ุดุฑูุญ ุฅุถุงููุฉ.
          `
        },
        { role: "user", content: userInput }
      ],
      temperature: 0.0,
    });

    const name = response.choices[0].message.content.trim();
    return name;
  } catch (error) {
    console.error("โ ุฎุทุฃ ูู getStandardName:", error.message);
    // fallback: ูุฑุฌูุน ููุณ ูุง ูุชุจู ุงููุณุชุฎุฏู
    return userInput;
  }
}

// ููุทุฉ ุฅูุดุงุก/ุฌูุจ ุงูุฏุฑุงุณุฉ
app.post('/generate-study', async (req, res) => {
  let userActivity = req.body.activity;
  console.log(`๐ ุทูุจ ุฏุฑุงุณุฉ ููุดุงุท: ${userActivity}`);

  try {
    // 1๏ธโฃ ุชูุญูุฏ ุงูุงุณู ุจูุธุงู ุฐูู ูุญุงูุธ ุนูู ููุน ุงููุดุงุท
    const standardName = await getStandardName(userActivity);

    // ๐ ูู ุงูู Guard ุฑุฌูุน REFUSED
    if (standardName === "REFUSED") {
      console.log("โ ุชู ุฑูุถ ุงูุทูุจ: ุงููุต ููุณ ูุดุงุทูุง ุงูุชุตุงุฏูุงู ูุงุถุญุงู.");
      return res.status(400).json({
        error: "ุนููุงูุ ุงููุต ุงููุฏุฎู ูุง ูุจุฏู ูุงุณู ูุดุงุท ุชุฌุงุฑู ุฃู ุตูุงุนู ุฃู ุฎุฏูู ูุงุถุญ. ุจุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุดุงุท ูุซู: ุชุฌุงุฑุฉ ุงูููุงุจุณ ุงูุฌุงูุฒุฉุ ุตูุงุนุฉ ุงูุจูุงุณุชููุ ูุฒุฑุนุฉ ููุงุดู..."
      });
    }

    console.log(`โ ุงูุงุณู ุงูููุญุฏ ูููุดุงุท: ${standardName}`);

    // 2๏ธโฃ ุงูุจุญุซ ูู ุงูุฃุฑุดูู (Neon) ุจููุณ ุงูุงุณู ุงูููุญุฏ
    const dbCheck = await pool.query(
      "SELECT * FROM studies WHERE activity_name = $1",
      [standardName]
    );

    if (dbCheck.rows.length > 0) {
      console.log("๐ ุชูุช ุฅุนุงุฏุฉ ุงููุดุงุท ูู ุงูุฃุฑุดูู ุงูุณุญุงุจู.");
      return res.json({
        result: dbCheck.rows[0].content,
        source: "archive",
        official_name: standardName
      });
    }

    console.log("โก ูู ูุชู ุงูุนุซูุฑ ูู ุงูุฃุฑุดูู โ ุณูุชู ุฅูุดุงุก ุฏุฑุงุณุฉ ุฌุฏูุฏุฉ ุนุจุฑ Gemini...");

    // 3๏ธโฃ ุฅูุดุงุก ุงูุฏุฑุงุณุฉ ุจุงุณุชุฎุฏุงู Gemini (ูุน ุงุญุชุฑุงู ุทุจูุนุฉ ุงููุดุงุท)
    const prompt = `
ุฃูุช ูุณุชุดุงุฑ ุงุฆุชูุงูู ูู ุจูู.  
ุงูุชุจ "ุฏุฑุงุณุฉ ุณูู ุชูุตูููุฉ" ูููุดุงุท ุงูุชุงูู:
"${standardName}"

ุงููุทููุจ:

1) ุงููุฎุฑุฌ ูููู HTML ููุท (ุจุฏูู ุฃู ูุต ุฎุงุฑุฌ ุงููุณูู) ุจุงุณุชุฎุฏุงู:
   - ุนูุงููู: <h3>
   - ููุงุฆู: <ul><li>
   - ุฌุฏุงูู: <table><thead><tbody><tr><th><td>

2) ุฑููุฒ ุฃู ุงูุฏุฑุงุณุฉ ุชูุงุณุจ ุงุณุชุฎุฏุงู "ุงุฆุชูุงูู" ููุจูู:
   - ุชุญููู ุงูุณูู ูุญุฌู ุงูุทูุจ.
   - ุงูููุฑุฏูู / ุงูุนููุงุก ุงููุณุชูุฏููู.
   - ุฏูุฑุฉ ุงูุชุดุบูู (ุฃูุงู ุดุฑุงุก โ ุชุตููุน/ุฎุฏูุฉ โ ุชุฎุฒูู โ ุชุญุตูู).
   - ูุณุจ ุฑุจุญูุฉ ุชูุฏูุฑูุฉ.
   - ุงููุฎุงุทุฑ ุงูุฃุณุงุณูุฉ ูููููุฉ ุงูุญุฏ ูููุง.
   - ุชูุตูุฉ ุงุฆุชูุงููุฉ ูู ุงูููุงูุฉ.

ุงููููู ุงูููุชุฑุญ:
<h3>1๏ธโฃ ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุดุงุท</h3>
(ููุฑุฉ ุทูููุฉ ูู 8โ12 ุณุทุฑ ุชูุฑูุจุงู)

<h3>2๏ธโฃ ูุงุฆูุฉ ุงูููุชุฌุงุช</h3>
<ul>
<li>โฆ</li>
</ul>

<h3>3๏ธโฃ ูููู ุงูุณูู ูุงูููุงูุณุฉ</h3>
<ul>
<li>โฆ</li>
</ul>

<h3>4๏ธโฃ ุฏูุฑุฉ ุงูุชุดุบูู ูุฃูุงู ุงูุฏูุฑุฉ</h3>
<table>
<thead>
<tr><th>ุงููุฑุญูุฉ</th><th>ุงููุตู</th><th>ุนุฏุฏ ุงูุฃูุงู</th></tr>
</thead>
<tbody>
<tr><td>โฆ</td><td>โฆ</td><td>โฆ</td></tr>
</tbody>
</table>

<h3>5๏ธโฃ ุงูุชูุงููู ูููุงูุด ุงูุฑุจุญ</h3>
<ul>
<li>ุชูููุฉ ุงูุจุถุงุนุฉ ุฅูู ุงููุจูุนุงุช (% ุชูุฑูุจูุฉ)</li>
<li>ูุตุงุฑูู ุชุดุบูููุฉ (% ุชูุฑูุจูุฉ)</li>
<li>ูุงูุด ุงูุฑุจุญ ุงูุชุดุบููู (% ุชูุฑูุจูุฉ)</li>
</ul>

<h3>6๏ธโฃ ุชุญููู SWOT</h3>
<ul>
<li><b>ููุงุท ุงูููุฉ:</b> โฆ</li>
<li><b>ููุงุท ุงูุถุนู:</b> โฆ</li>
<li><b>ุงููุฑุต:</b> โฆ</li>
<li><b>ุงูุชูุฏูุฏุงุช:</b> โฆ</li>
</ul>

<h3>7๏ธโฃ ุงููุฎุงุทุฑ ุงูุฑุฆูุณูุฉ ูููููุฉ ุงูุญุฏ ูููุง</h3>
<ul>
<li><b>ูุฎุงุทุฑ ุงูุณูู:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ุชูููุน ูุงุนุฏุฉ ุงูุนููุงุก โ ุนููุฏ ุชูุฑูุฏ ูุณุชูุฑุฉ โ ุฏุฑุงุณุฉ ุฏูุฑูุฉ ููุฃุณุนุงุฑ.</li>

<li><b>ูุฎุงุทุฑ ุงูุชุดุบูู:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ุชุญุณูู ูุธู ุงูุฅุฏุงุฑุฉ โ ุชุฏุฑูุจ ุงูุนูุงูุฉ โ ูุฌูุฏ ุฎุทุท ุชุดุบูู ุจุฏููุฉ.</li>

<li><b>ูุฎุงุทุฑ ุงูุชูููู:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ุฅุฏุงุฑุฉ ุฌูุฏุฉ ููุชุฏููุงุช ุงูููุฏูุฉ โ ุชูุฒูุน ุงูุงูุชุฒุงูุงุช โ ุงูุชุญูู ูู ูุชุฑุฉ ุงูุงุฆุชูุงู.</li>

<li><b>ูุฎุงุทุฑ ุงูููุฑุฏูู:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ุชุนุฏุฏ ุงูููุฑุฏูู โ ุนููุฏ ูุงุถุญุฉ โ ูุฎุฒูู ุฃูุงู.</li>

<li><b>ูุฎุงุทุฑ ุงูุนููุงุก ูุงูุชุญุตูู:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ูุญุต ุงูุนููุงุก โ ุชูููู ูุชุฑุฉ ุงูุชุญุตูู โ ุถูุงูุงุช ููุงุณุจุฉ.</li>

<li><b>ูุฎุงุทุฑ ุงูููุงูุณุฉ:</b> โฆ  
   <br>๐น <i>ุฃุณุงููุจ ุงูุญุฏ ูููุง:</i> ุชุญุณูู ุงูุฌูุฏุฉ โ ุชุณุนูุฑ ุชูุงูุณู โ ุงูุชูุณุน ุงูุฑููู.</li>
</ul>


<h3>8๏ธโฃ ุงูุฑุฃู ุงูุนุงู ุญูู ููุงุกูุฉ ุงููุดุงุท</h3>
<p>
ูุฐุง ุงูุฑุฃู ุนุงู ุญูู ุงููุดุงุท ููุทุ ููุง ููุซู ูุฑุงุฑูุง ุงุฆุชูุงูููุง  
ูุธุฑูุง ูุนุฏู ุชููุฑ ุจูุงูุงุช ูุงููุฉ ุฃู ุณููููุฉ ุชุฎุต ุงูุนููู.
</p>

<ul>
<li><b>ููุงุกูุฉ ุงููุดุงุท ููุณูู:</b> โฆ</li>
<li><b>ุนูุงูู ุงููุฌุงุญ:</b> โฆ</li>
<li><b>ุงูุชุญุฏูุงุช:</b> โฆ</li>
<li><b>ุงูุชูููู ุงูุนุงู:</b> ุงููุดุงุท ููุงุณุจ ููุนูู ุดุฑุท ุงูุงูุชุฒุงู ุจููุงุฑุณุงุช ุชุดุบูููุฉ ููุงููุฉ ุณูููุฉ.</li>
</ul>
ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ุฑุณููุฉ ููุงุถุญุฉุ ูุงุจุชุนุฏ ุนู ุงูุชูุฑุงุฑ ูุฏุฑ ุงูุฅููุงู.
    `;

    const result = await googleModel.generateContent(prompt);
    const studyContent = result.response.text();

    // ุฅุฒุงูุฉ ุฃู ```html ุฃู ``` ูู ุงููุฎุฑุฌ
    const cleanContent = studyContent
      .replace(/```html/gi, '')
      .replace(/```/g, '');

    // 4๏ธโฃ ุญูุธ ุงูุฏุฑุงุณุฉ ูู ุงูุฃุฑุดูู
    await pool.query(
      "INSERT INTO studies (activity_name, content) VALUES ($1, $2)",
      [standardName, cleanContent]
    );

    console.log("โ ุชู ุญูุธ ุงูุฏุฑุงุณุฉ ุงูุฌุฏูุฏุฉ ูู ุงูุฃุฑุดูู.");

    return res.json({
      result: cleanContent,
      source: "ai",
      official_name: standardName
    });

  } catch (error) {
    console.error("๐ฅ ุฎุทุฃ ูู /generate-study:", error);
    return res.status(500).json({
      error: "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุนุฏุงุฏ ุงูุฏุฑุงุณุฉ",
      details: error.message
    });
  }
});

// ุงุณุชุฑุฌุงุน ุงูุฃุฑุดูู ุจุงููุงูู
app.get('/all-studies', async (req, res) => {
  try {
    const result = await pool.query(
      "SELECT * FROM studies ORDER BY id DESC"
    );
    res.json({ studies: result.rows });
  } catch (err) {
    console.error("โ ูุดู ุชุญููู ุงูุฃุฑุดูู:", err);
    res.status(500).json({ error: "ูุดู ุชุญููู ุงูุฃุฑุดูู" });
  }
});

// ุฎุฏูุฉ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

const PORT = process.env.PORT || 3000;
const server = app.listen(PORT, () =>
  console.log(`๐ ุงูุณูุฑูุฑ ูุนูู ุนูู ุงูุจูุฑุช ${PORT} ููุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช`)
);

// ุฒูุงุฏุฉ ูููุฉ ุงูุงุณุชุฌุงุจุฉ ุฅูู 5 ุฏูุงุฆู
server.setTimeout(300000);
